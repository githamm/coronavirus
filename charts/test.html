<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex,follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorado Coronavirus Tracker | The Denver Post</title>
    <link rel="shortcut icon" href="https://extras.mnginteractive.com/live/media/favIcon/dpo/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/foundation/6.2.4/foundation.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.14/c3.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/foundation/6.2.4/foundation.min.js"></script>
    <script src="https://extras.denverpost.com/foundation/js/vendor/modernizr.js"></script>
    <script src="https://extras.denverpost.com/app/homicide-report/js/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.14/c3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto');

    html,
    body {
        height: 100%;
        width: 100%;
        padding: 0;
        background-color: #fafafa;
        font-family: 'Roboto', sans-serif;
        margin-top: 1%;
    }

    #map {
        height: 600px;
        width: 100%;
        /*width: 893px;
        height: 600px;
        margin: 0 auto;*/
        border: 2px solid silver;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 0;
        background-color: #fafafa;
        /*max-width: 200px;*/
        line-height: 100%;
    }

    .leaflet-container {
        font-family: 'Roboto', sans-serif;
        font-size: 1rem;
    }

    /*.leaflet-popup-content {
        font-size: 1.2em;
        letter-spacing: .2px;
    }*/

    .popup-header {
        font-size: 1.75rem;
        font-weight: bold;
        color: #525252;
        margin-bottom: -16px;
    }
    </style>
</head>

<body>
    <div id="cases-chart"></div>
    <hr>
    <div id="map"></div>
    <script>
    var chartSpreadsheetID = "1le-2tlErhBUQe3ya-H-c3YqCjdmwwSNWEvAHnshrP3E/2";
    var url = "https://spreadsheets.google.com/feeds/list/" + chartSpreadsheetID + "/public/full?alt=json";

    $.getJSON(url, function(data) {
        var sheetJson = data.feed.entry;
        //console.log(sheetJson);
        var quarterlyMoneyChart = c3.generate({
            bindto: '#cases-chart',
            size: {
                height: 425
                //width: 800
            },
            data: {
                json: sheetJson,
                keys: {
                    x: 'gsx$date.$t',
                    value: ['gsx$dailycases.$t', 'gsx$cumulativecases.$t' /*,'gsx$dailydeaths.$t','gsx$cumulativedeaths.$t'*/ ]
                },
                names: {
                    'gsx$dailycases.$t': 'Daily cases',
                    'gsx$cumulativecases.$t': 'Total cases',
                    //'gsx$dailydeaths.$t': 'Daily deaths',
                    //'gsx$cumulativedeaths.$t': 'Total deaths'
                },
                types: {
                    'gsx$dailycases.$t': 'bar',
                    'gsx$cumulativecases.$t': 'line',
                    //'gsx$dailydeaths.$t': 'bar',
                    //'gsx$cumulativedeaths.$t': 'line'
                },
                colors: {
                    'gsx$dailycases.$t': 'rgba(8,81,156,.5)',
                    'gsx$cumulativecases.$t': 'rgba(8,81,156,1)',
                    //'gsx$dailydeaths.$t': 'rgba(165,15,21,.5)',
                    //'gsx$cumulativedeaths.$t': 'rgba(165,15,21,1)'
                },
            },
            // padding: {
            //     bottom: 25
            // },
            axis: {
                x: {
                    type: 'category',
                    tick: {
                        rotate: 0,
                        multiline: false,
                        culling: true
                    },
                },
                y: {
                    max: 45
                }
            },
            legend: {
                position: 'inset'
            },
            grid: {
                x: {
                    show: true
                },
                y: {
                    show: true
                }
            },
            point: {
                r: 4
            }
        });
    });

    ///// MAP /////
    // var map = L.map('map', {
    //     center: [39.0501, -105.3821],
    //     zoom: 7,
    //     minZoom: 7,
    //     maxZoom: 10,
    //     preferCanvas: true,
    //     scrollWheelZoom: false
    // });

    // L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    //     subdomains: 'abcd',
    //     maxZoom: 19
    // }).addTo(map);

    // //var mapSpreadsheetID = "1le-2tlErhBUQe3ya-H-c3YqCjdmwwSNWEvAHnshrP3E/3";
    // var mapSpreadsheetID = '1EUFSaqi30b6oefK0YWWNDDOzwmCTTXlXkFHAc2QrUxM';
    // var url = "https://spreadsheets.google.com/feeds/list/" + mapSpreadsheetID + "/public/full?alt=json";

    // function init() {
    //     Tabletop.init({
    //         key: mapSpreadsheetID,
    //         callback: myFunction,
    //         simpleSheet: true
    //     })
    // }

    // window.addEventListener('DOMContentLoaded', init)

    // function myFunction(data, tabletop) {
    //     //console.log(data);
    //     function addPolygons(data, tabletop) {
    //         // the empty GeoJSON waiting to be populated with features
    //         var polygons = {
    //             "type": "FeatureCollection",
    //             "features": []
    //         }

    //         for (var row in data) {
    //             // JSON.parse converts the geometry strings into JSON objects
    //             var coords = JSON.parse(data[row].geometry);
    //             console.log(coords);
    //             polygons.features.push({
    //                 "type": "Feature",
    //                 "geometry": {
    //                     "type": "MultiPolygon",
    //                     "coordinates": coords
    //                 },
    //                 "properties": {
    //                     "name": data[row].name,
    //                 }
    //             });
    //         }
    //         polygonMarkers = L.geoJSON(polygons, {
    //             onEachFeature: function(feature, layer) {
    //                 layer.bindPopup(feature.properties.name);
    //             },
    //         }).addTo(map);
    //     }
    // }

    // $.getJSON(url, function(mapData) {
    //     var sheetJson = mapData.feed.entry;
    //     console.log(sheetJson);

    //     function addPolygons(sheetJson) {
    //         // the empty GeoJSON waiting to be populated with features
    //         var polygons = {
    //             "type": "FeatureCollection",
    //             "features": []
    //         }

    //         for (var row in sheetJson) {
    //             // JSON.parse converts the geometry strings into JSON objects
    //             var coords = JSON.parse(sheetJson[row].gsx$geometry.$t);
    //             console.log(sheetJson);
    //             polygons.features.push({
    //                 "type": "Feature",
    //                 "geometry": {
    //                     "type": "MultiPolygon",
    //                     "coordinates": coords
    //                 },
    //                 "properties": {
    //                     "name": data[row].name,
    //                 }
    //             });
    //         }
    //     }
    // })

    /*
     * Script to display two tables from Google Sheets as point and polygon layers using Leaflet
     * Starts by importing JSONs representing the data to provide faster loading (and in case Google changes their API)
     * The Sheets are then imported using Tabletop.js and overwrite the initially laded layers
     */

    // The two getJSON calls load the localy stored JSONs and call the appropriate functions
    // $.getJSON("/leaflet-gsheets/data-sources/US-states-leaflet.json", function(json) {
    //     addPolygons(json);
    // });

    // $.getJSON("/leaflet-gsheets/data-sources/US-points.json", function(json) {
    //     addPoints(json);
    // });

    // init() is called as soon as the page loads
    function init() {

        // these URLs come from Google Sheets "shareable link" form
        // the first is the polygon layer and the second the points
        //var polyURL = "https://docs.google.com/spreadsheets/d/1EUFSaqi30b6oefK0YWWNDDOzwmCTTXlXkFHAc2QrUxM/edit?usp=sharing";

        var polyURL = 'https://docs.google.com/spreadsheets/d/1V6rB1-PTfoMCLHKqTQrv6m5AJwWcbRP269t0cvD3Ios/edit?usp=sharing';

        Tabletop.init({
            key: polyURL,
            callback: addPolygons,
            simpleSheet: true
        });
    }
    window.addEventListener("DOMContentLoaded", init);

    // Create a new Leaflet map centered on the continental US
    var map = L.map("map").setView([40, -100], 4);

    // This is the Carto Positron basemap
    var basemap = L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://cartodb.com/attributions">CartoDB</a>',
        subdomains: "abcd",
        maxZoom: 19
    });
    basemap.addTo(map);

    // These are declared outisde the functions so that the functions can check if they already exist
    var polygonLayer;

    // The form of data must be a JSON representation of a table as returned by Tabletop.js
    // addPolygons first checks if the map layer has already been assigned, and if so, deletes it and makes a fresh one
    // The assumption is that the locally stored JSONs will load before Tabletop.js can pull the external data from Google Sheets
    function addPolygons(data) {
        if (polygonLayer != null) {
            // If the layer exists, remove it and continue to make a new one with data
            polygonLayer.remove()
        }

        // Need to convert the Tabletop.js JSON into a GeoJSON
        // Start with an empty GeoJSON of type FeatureCollection
        // All the rows will be inserted into a single GeoJSON
        var geojsonStates = {
            "type": "FeatureCollection",
            "features": []
        };

        for (var row in data) {
            // The Sheets data has a column "include" that specifies if that row should be mapped
            var coords = JSON.parse(data[row].geometry);

            geojsonStates.features.push({
                "type": "Feature",
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": coords
                },
                "properties": {
                    "name": data[row].name
                    //"summary": data[row].summary,
                    //"state": data[row].state,
                    //"local": data[row].local,
                }
            });
        }

        // The polygons are styled slightly differently on mouse hovers
        var poylgonStyle = { "color": "#2ca25f", "fillColor": "#99d8c9", "weight": 1.5 };
        var polygonHoverStyle = { "color": "green", "fillColor": "#2ca25f", "weight": 3 };

        polygonLayer = L.geoJSON(geojsonStates, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup("<h2>" + feature.properties.name + "</p>");
                layer.on({
                    mouseout: function(e) {
                        e.target.setStyle(poylgonStyle);
                    },
                    mouseover: function(e) {
                        e.target.setStyle(polygonHoverStyle);
                    },
                    click: function(e) {
                        // This zooms the map to the clicked polygon
                        // Not always desirable
                        // map.fitBounds(e.target.getBounds());
                    }
                });
            },
            style: poylgonStyle
        }).addTo(map);
    }
    </script>
</body>

</html>